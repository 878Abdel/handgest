<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Test OpenCV + ArUco Detection</title>
  <style>
    body {
      font-family: monospace;
      background: #000;
      color: #0f0;
      padding: 20px;
      line-height: 1.6;
    }
    h1 { color: #0ff; }
    .status { margin: 20px 0; padding: 10px; border: 2px solid #0f0; border-radius: 5px; }
    .status.error { border-color: #f00; color: #f00; }
    .status.success { border-color: #0f0; color: #0f0; }
    .status.warning { border-color: #ff0; color: #ff0; }
    video { width: 400px; margin: 10px 0; border: 2px solid #0f0; }
    canvas { width: 400px; border: 2px solid #0ff; margin: 10px 0; }
    button { padding: 10px 20px; margin: 5px; font-weight: bold; cursor: pointer; }
  </style>
</head>
<body>
  <h1>ğŸ§ª TEST OPENCV + ARUCO</h1>
  
  <div id="log"></div>

  <div class="status" id="opencvStatus">ğŸ“¦ OpenCV: Chargement...</div>
  <div class="status" id="cvStatus">ğŸ” cv global: Attente...</div>
  <div class="status" id="cameraStatus">ğŸ“· CamÃ©ra: Attente...</div>
  <div class="status" id="detectionStatus">ğŸ¯ DÃ©tection: Attente...</div>

  <h2>Flux vidÃ©o:</h2>
  <video id="video" autoplay playsinline muted></video>
  
  <h2>Canvas de dÃ©tection:</h2>
  <canvas id="canvas" width="1280" height="720"></canvas>

  <h2>ContrÃ´les:</h2>
  <button onclick="startDetection()">â–¶ï¸ DÃ©marrer dÃ©tection</button>
  <button onclick="stopDetection()">â¹ï¸ ArrÃªter</button>
  <button onclick="testOpenCV()">ğŸ§ª Tester OpenCV</button>

  <script>
    let opencvReady = false;
    let detectionRunning = false;
    let videoStream = null;

    function log(msg, type = 'normal') {
      const logDiv = document.getElementById('log');
      const line = document.createElement('div');
      line.textContent = msg;
      if (type === 'error') line.style.color = '#f00';
      if (type === 'success') line.style.color = '#0f0';
      if (type === 'warning') line.style.color = '#ff0';
      logDiv.appendChild(line);
      console.log(msg);
    }

    function updateStatus(id, text, type = 'normal') {
      const el = document.getElementById(id);
      el.textContent = text;
      el.className = 'status';
      if (type === 'error') el.className += ' error';
      if (type === 'success') el.className += ' success';
      if (type === 'warning') el.className += ' warning';
    }

    // Callback OpenCV
    window.onOpenCvReady = function() {
      log('âœ… onOpenCvReady() callback dÃ©clenchÃ©', 'success');
      opencvReady = true;
      updateStatus('opencvStatus', 'âœ… OpenCV.js: Callback reÃ§u', 'success');
      testOpenCV();
    };

    // Charger OpenCV
    function loadOpenCV() {
      log('ğŸ”„ CrÃ©ation du script OpenCV...');
      const script = document.createElement('script');
      script.src = 'https://docs.opencv.org/4.6.0/opencv.js';
      
      script.onload = function() {
        log('âœ… Script chargÃ©', 'success');
        updateStatus('opencvStatus', 'âœ… OpenCV.js: Script chargÃ©', 'success');
        
        setTimeout(() => {
          if (typeof cv !== 'undefined') {
            log('âœ… cv global disponible', 'success');
            opencvReady = true;
            updateStatus('cvStatus', 'âœ… cv global: Disponible', 'success');
            testOpenCV();
          } else {
            log('âš ï¸ cv global pas disponible aprÃ¨s load', 'warning');
            updateStatus('cvStatus', 'âš ï¸ cv global: Pas disponible', 'warning');
          }
        }, 100);
      };
      
      script.onerror = function() {
        log('âŒ Erreur chargement OpenCV', 'error');
        updateStatus('opencvStatus', 'âŒ OpenCV.js: Erreur chargement', 'error');
      };
      
      document.head.appendChild(script);
    }

    function testOpenCV() {
      log('\nğŸ§ª Test OpenCV...');
      
      if (typeof cv === 'undefined') {
        log('âŒ cv pas disponible', 'error');
        updateStatus('cvStatus', 'âŒ cv global: PAS disponible', 'error');
        return;
      }
      
      log('âœ… cv.Mat: ' + typeof cv.Mat, 'success');
      log('âœ… cv.matFromImageData: ' + typeof cv.matFromImageData, 'success');
      log('âœ… cv.cvtColor: ' + typeof cv.cvtColor, 'success');
      log('âœ… cv.getPredefinedDictionary: ' + typeof cv.getPredefinedDictionary, 'success');
      log('âœ… cv.ArucoDetector: ' + typeof cv.ArucoDetector, 'success');
      log('âœ… cv.DICT_6X6_250: ' + typeof cv.DICT_6X6_250, 'success');
      
      updateStatus('cvStatus', 'âœ… cv global: Tous les outils disponibles', 'success');
    }

    async function initCamera() {
      log('\nğŸ“· Demande accÃ¨s camÃ©ra...');
      try {
        videoStream = await navigator.mediaDevices.getUserMedia({
          video: {
            width: { ideal: 1280 },
            height: { ideal: 720 }
          }
        });
        
        document.getElementById('video').srcObject = videoStream;
        
        await new Promise(resolve => {
          document.getElementById('video').onloadedmetadata = () => {
            document.getElementById('video').play();
            log('âœ… CamÃ©ra dÃ©marrÃ©e', 'success');
            updateStatus('cameraStatus', 'âœ… CamÃ©ra: Active', 'success');
            resolve();
          };
        });
      } catch (error) {
        log('âŒ Erreur camÃ©ra: ' + error.message, 'error');
        updateStatus('cameraStatus', 'âŒ CamÃ©ra: ' + error.message, 'error');
      }
    }

    function startDetection() {
      if (!opencvReady || typeof cv === 'undefined') {
        log('âŒ OpenCV pas prÃªt', 'error');
        return;
      }

      if (!videoStream) {
        log('ğŸ“· Initialisation camÃ©ra...', 'warning');
        initCamera().then(() => startDetection());
        return;
      }

      detectionRunning = true;
      log('\nâ–¶ï¸ DÃ©tection dÃ©marrÃ©e', 'success');
      updateStatus('detectionStatus', 'â–¶ï¸ DÃ©tection: En cours', 'success');
      
      detectFrame();
    }

    function stopDetection() {
      detectionRunning = false;
      log('â¹ï¸ DÃ©tection arrÃªtÃ©e', 'warning');
      updateStatus('detectionStatus', 'â¹ï¸ DÃ©tection: ArrÃªtÃ©e', 'warning');
    }

    let detectionCount = 0;
    function detectFrame() {
      if (!detectionRunning) return;

      requestAnimationFrame(detectFrame);

      const video = document.getElementById('video');
      const canvas = document.getElementById('canvas');
      const ctx = canvas.getContext('2d');

      if (video.readyState !== video.HAVE_ENOUGH_DATA) return;

      try {
        // Dessiner la vidÃ©o sur le canvas
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);

        // DÃ©tection
        let img = cv.matFromImageData(imageData);
        let gray = new cv.Mat();
        cv.cvtColor(img, gray, cv.COLOR_RGBA2GRAY);
        cv.GaussianBlur(gray, gray, new cv.Size(5, 5), 0);

        let dictionary = cv.getPredefinedDictionary(cv.DICT_6X6_250);
        let detector = new cv.ArucoDetector(dictionary);
        
        let corners = new cv.MatVector();
        let ids = new cv.Mat();
        detector.detectMarkers(gray, corners, ids);

        let markerCount = ids.rows;
        detectionCount++;

        if (detectionCount % 30 === 0) { // Log toutes les 30 frames
          if (markerCount > 0) {
            log(`âœ… ${markerCount} marqueur(s) dÃ©tectÃ©(s)!`, 'success');
            updateStatus('detectionStatus', `âœ… ${markerCount} marqueur(s) trouvÃ©(s)!`, 'success');
          } else {
            log(`âŒ Aucun marqueur (frame ${detectionCount})`, 'warning');
          }
        }

        // Dessiner les marqueurs
        if (markerCount > 0) {
          for (let i = 0; i < markerCount; i++) {
            let corners_i = corners.get(i);
            
            ctx.strokeStyle = '#00ff00';
            ctx.lineWidth = 3;
            ctx.beginPath();
            
            for (let j = 0; j < 4; j++) {
              const x = corners_i.data32F[j * 2];
              const y = corners_i.data32F[j * 2 + 1];
              if (j === 0) ctx.moveTo(x, y);
              else ctx.lineTo(x, y);
            }
            
            const x = corners_i.data32F[0];
            const y = corners_i.data32F[1];
            ctx.lineTo(x, y);
            ctx.stroke();
            
            // ID du marqueur
            const id = ids.data32S[i];
            ctx.fillStyle = '#ff00ff';
            ctx.font = 'bold 20px Arial';
            ctx.fillText('ID:' + id, x, y - 10);
          }
        }

        img.delete();
        gray.delete();
        dictionary.delete();
        detector.delete();
        corners.delete();
        ids.delete();

      } catch (error) {
        log('âŒ Erreur dÃ©tection: ' + error.message, 'error');
      }
    }

    // DÃ©marrage
    window.addEventListener('load', () => {
      log('ğŸš€ Page chargÃ©e');
      loadOpenCV();
    });
  </script>
</body>
</html>
